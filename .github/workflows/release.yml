name: Release to Production

on:
  push:
    tags:
      - '*'

env:
  IMAGE_TAG: v.${{ github.ref_name }}
  INTERNAL_REGISTRY_URL: ${{ secrets.INTERNAL_REGISTRY_URL }}
  API_IMAGE_NAME: ${{ secrets.INTERNAL_REGISTRY_URL }}/recipes
  UI_IMAGE_NAME: ${{ secrets.INTERNAL_REGISTRY_URL }}/recipes-ui
  GITOPS_REPO: fricker-studios/gitops-prod
  GITOPS_SOURCE_DIR: recipes
  GITOPS_DEMO_REPO: fricker-studios/gitops-demo
  GITOPS_DEMO_SOURCE_DIR: recipes
  # ARGO_CD_APP_REPO: gitlab.alexfricker.com/devops/gitops-prod.git
  # ARGO_CD_DEMO_REPO: gitlab.alexfricker.com/devops/gitops-demo.git
  # ARGOCD_APP_NAME: recipes-prod

jobs:
  build-ui-files:
    runs-on: self-hosted
    name: Build UI Files

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set Up Environment
        run: make env

      - name: Build UI files
        env:
          SENTRY_DSN_UI: ${{ secrets.SENTRY_DSN_UI }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN_UI }}
        run: |
          make env
          echo "VITE_SENTRY_ENVIRONMENT=prod" >> frontend/.env
          echo "VITE_SENTRY_RELEASE=\"$IMAGE_TAG\"" >> frontend/.env
          echo "VITE_SENTRY_DSN=\"$SENTRY_DSN_UI\"" >> frontend/.env
          export SENTRY_AUTH_TOKEN=$SENTRY_AUTH_TOKEN
          npm --prefix=frontend run build
          ./.venv/bin/python3 manage.py collectstatic --noinput

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: node-modules-${{ hashFiles('frontend/package.json') }}

      - name: Cache Python venv
        uses: actions/cache@v4
        with:
          path: .venv
          key: python-venv-${{ hashFiles('pyproject.toml') }}

      - name: Upload UI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ui-files
          path: |
            frontend/dist
            staticfiles

  build-image-api:
    runs-on: self-hosted
    name: Build API Image
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and push image
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          API_IMAGE_NAME: ${{ env.API_IMAGE_NAME }}
        run: |
          docker build -t $API_IMAGE_NAME:$IMAGE_TAG -f Dockerfile . --build-arg SENTRY_RELEASE_VERSION=$IMAGE_TAG
          docker push $API_IMAGE_NAME:$IMAGE_TAG

  build-image-ui:
    runs-on: self-hosted
    name: Build UI Image
    needs: build-ui-files

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download UI artifacts 
      uses: actions/download-artifact@v4
      with:
        name: ui-files

    - name: Build and push image
      env:
        IMAGE_TAG: ${{ env.IMAGE_TAG }}
        UI_IMAGE_NAME: ${{ env.UI_IMAGE_NAME }}
      run: |
        docker build -t $UI_IMAGE_NAME:$IMAGE_TAG -f Dockerfile.nginx .
        docker push $UI_IMAGE_NAME:$IMAGE_TAG

  update-gitops-manifest:
    runs-on: self-hosted
    name: Update GitOps Manifest
    needs: [build-image-api, build-image-ui]

    steps:
    - name: Checkout gitops repo
      uses: actions/checkout@v4
      with:
        repository: ${{ env.GITOPS_REPO }}
        token: ${{ secrets.GITOPS_PAT }}
        path: gitops

    - name: Update kustomization.yaml
      env:
        IMAGE_TAG: ${{ env.IMAGE_TAG }}
      run: |
        cd gitops/${{ env.GITOPS_SOURCE_DIR }}
        # Update image tags
        sed -i "s|newTag: .*|newTag: $IMAGE_TAG|g" kustomization.yaml
        cat kustomization.yaml

    - name: Commit and push changes
      env:
        IMAGE_TAG: ${{ env.IMAGE_TAG }}
      run: |
        cd gitops
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add ${{ env.GITOPS_SOURCE_DIR }}/kustomization.yaml
        git commit -m "Update ${{ env.GITOPS_SOURCE_DIR }} images to $IMAGE_TAG" || echo "No changes to commit"
        git push

  update-demo-manifests:
    runs-on: self-hosted
    name: Update GitOps Demo Manifest
    needs: [build-image-api, build-image-ui]

    steps:
    - name: Checkout gitops repo
      uses: actions/checkout@v4
      with:
        repository: ${{ env.GITOPS_DEMO_REPO }}
        token: ${{ secrets.GITOPS_PAT }}
        path: gitops

    - name: Update kustomization.yaml
      env:
        IMAGE_TAG: ${{ env.IMAGE_TAG }}
      run: |
        cd gitops/${{ env.GITOPS_DEMO_SOURCE_DIR }}
        # Update image tags
        sed -i "s|newTag: .*|newTag: $IMAGE_TAG|g" kustomization.yaml
        cat kustomization.yaml

    - name: Commit and push changes
      env:
        IMAGE_TAG: ${{ env.IMAGE_TAG }}
      run: |
        cd gitops
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add ${{ env.GITOPS_DEMO_SOURCE_DIR }}/kustomization.yaml
        git commit -m "Update ${{ env.GITOPS_DEMO_SOURCE_DIR }} images to $IMAGE_TAG" || echo "No changes to commit"
        git push

  create-github-release:
    runs-on: self-hosted
    name: Create GitHub Release
    needs: [build-image-api, build-image-ui]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.GITOPS_PAT }}
        tag_name: ${{ github.ref_name }}
        name: Release ${{ env.IMAGE_TAG }}
        body: |
          ## Release ${{ env.IMAGE_TAG }}
          
          **Docker Images:**
          - API: `${{ env.API_IMAGE_NAME }}:${{ env.IMAGE_TAG }}`
          - UI: `${{ env.UI_IMAGE_NAME }}:${{ env.IMAGE_TAG }}`
          
          **GitOps Repository:** ${{ env.GITOPS_REPO }}
        draft: false
        prerelease: false

  create-sentry-release:
    runs-on: self-hosted
    name: Create Sentry Release
    needs: [build-image-api, build-image-ui]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create Sentry Release
      env:
        IMAGE_TAG: ${{ env.IMAGE_TAG }}
        SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN_UI }}
      run: |
        export SENTRY_AUTH_TOKEN=$SENTRY_AUTH_TOKEN
        export SENTRY_ORG=sentry
        export SENTRY_PROJECT=recipes
        sentry-cli --url https://sentry.alexfricker.com/ releases new "$IMAGE_TAG"
        sentry-cli --url https://sentry.alexfricker.com/ releases set-commits "$IMAGE_TAG" --auto --ignore-missing
        sentry-cli --url https://sentry.alexfricker.com/ releases finalize "$IMAGE_TAG"
